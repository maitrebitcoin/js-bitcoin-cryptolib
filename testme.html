<!DOCTYPE html>
<html>
<body>

<h1> js-bitcoin-cryptolib test page </h1>
<p><hr><p>

<button onclick="testSha()">       <h2> Test sha256 </h2> </button>
<button onclick="testSha512()">    <h2> Test sha512 </h2> </button>
<button onclick="testHmacSha512()"><h2> Test hmac-sha512 </h2> </button>
<button onclick="testEcdsa()">     <h2> Test ecdsa  </h2> </button>
<button onclick="testBip32()">     <h2> Test bip32  </h2> </button>
<p>
<button onclick="testAll()">     <h2> Test ALL  </h2> </button>
<hr>
<button onclick="ecdsaSample()">   <h2> Ecdsa sample</h2> </button>
<button onclick="bip32Sample()">    <h2> bip32 sample</h2> </button>

<p><p>

<p style="font-family:monospace;font-size:160%" id="resultat">
    <!--auto test result here-->
</p>

<!----------------------------- javscript code -------------------------------->

<!--- @Temp to debug
<script src='js-bitcoin-lib.js'></script> 
---->
<script src='gfield.js'></script> 
<script src='ellipticurve.js'></script> 
<script src='ecdsa.js'></script> 
<script src='sha.js'></script> 
<script src='encodedecode.js'></script> 
<script src='hdwallet.js'></script> 
<script src='bip39.js'></script> 

<script src='autotest.js'></script>


<script>

// called if a test fails
function onTestFail( s, hashAsHexString, expected, message)
{
    var sErr = "hash('" + s+ "') => <br>\n" +  hashAsHexString+' != <br>\n'+expected
    console.log(sErr)

    document.getElementById("resultat").innerHTML += "<p>"  +sErr + '<hr>' + message + "<p><font color='red'>FAILED</font>";
    console.assert(false)
    // stop the test
    throw -1;
}
// called if a test runs ok
function onTestOK( s )
{
    console.log(s + " OK")
    document.getElementById("resultat").innerHTML += "<p>"  + s + " <font color='green'>OK</font>";
}
// called when all tests runs ok (eend)
function onAllTestFinisedOK()
{
    console.log("ALL TEST PASSED OK")
    document.getElementById("resultat").innerHTML += "<p><font color='green'>ALL TEST PASSED OK</font>";
}

function testAll() {
    // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";
    // Run the test async :
    autotest_all( onTestFail, onTestOK, onAllTestFinisedOK  );
}

function testSha() {
    // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";
    // Run the test async :
    setTimeout( () => {
        
        // Run tests...
        autotest_sha256( onTestFail  )
        // test PASSED OK
        document.getElementById("resultat").innerHTML += "<p><font color='green'>PASSED OK</font>";
        },0
    )
}
function testSha512() {
     // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";       
        // Run tests...
        autotest_sha512( onTestFail  )
        // test PASSED OK
        document.getElementById("resultat").innerHTML = "<p><font color='green'>PASSED OK</font>";
}
function testHmacSha512() {
     // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";       
        // Run tests...
        autotest_hmac_sha512( onTestFail  )
        // test PASSED OK
        document.getElementById("resultat").innerHTML = "<p><font color='green'>PASSED OK</font>";
}
function testEcdsa() {
    // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";
    // Run the test async :
    setTimeout( () => {
        
        // Run tests...
        autotest_ecdsa(  onTestFail  )

        // test PASSED OK
        document.getElementById("resultat").innerHTML += "<p><font color='green'>PASSED OK</font>";
        },0
    )
}
function testBip32() {
    // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";
     // Run tests...
     autotest_bip32(  onTestFail  )
     document.getElementById("resultat").innerHTML += "<p><font color='green'>PASSED OK</font>";

    
}





function ecdsaSample() {

    var ecdsa = new ECDSA();
    // create key pair
    var priv = ecdsa.newPrivateKey();
    var pub  = ecdsa.publicKeyFormPrivateKey(priv);
    // show keys
    var sDump = "private key :<p>" + priv.toString()

        
    // check signature
    var res = ecdsa.verifySignature(sMessage, signature, pub )
    sDump += "<hr>test signature : " + res.message

    document.getElementById("resultat").innerHTML = sDump;
}

function bip32Sample() {

    //@test
    // https://stuff.birkenstab.de/pbkdf2/

    var test4 =      PBKDF2_512( hmac_sha512, "password","salt", 4 )
    //    "a3e4e33fc661f01e0a0824950576713fca8c6c27971aff4c3088b3d41442e723d4b603f204e07129f54e7f9a26456eab8ed8406b7a7a0c7917a7635abde2b1b7"
    console.log( hex(test4) )  


    var phrase ="pistol thunder want public animal educate laundry all churn federal slab behind media front glow"
    var seedOK = bufferFromHex("6e85439607050fad311b71238aacdd27d3095329201baa367c43e93869621de213f2c75dac958ecc1a87d55a94baf02e223de1d686c276882c112e841b01a8df");
    var seed = bufferFromPhrase(phrase)
    console.log( hex(seed) )
    console.assert( seed == seedOK )
    
    var bip32 = new hdwallet( seed );

    var master   = bip32.getMasterKey()
    // should be "xprv9uVXYtuVbPpJQFs3ccU7odsG3m6iPp5jsAqXY1NstBEeLB1sj3sh572x8iSo16if7b9DFRXXZdMvHKvSm39oKNR7uXCHKwM9gc8EZgZk3bA"
    var extKeyM0   = bip32.getExtendedPrivateKeyFromPath("m/0")
    var extKeyMPub = bip32.getExtendedPubliceKeyFromPath("m/0")

//@temp
//    var xx= bip32.getPrivateKeyFromPath("bogeyman");
//    console.log("xx" + xx.toString());
//    return;

    var res   = master; //bip32.getMasterKey();

    // value ok
    //var resOKAsStr =  "xprv9s21ZrQH143K4b44oYF6VxMLbBroCaDgiWetWXeDHanBdreeF8bQpUndSvVgHHwQNkifjfwZXgY8Fxub73dLbnJ7we9FSaae5PvXjBTfw4Y"
    var resOKAsStr =  "xprv9uVXYtuVbPpJQFs3ccU7odsG3m6iPp5jsAqXY1NstBEeLB1sj3sh572x8iSo16if7b9DFRXXZdMvHKvSm39oKNR7uXCHKwM9gc8EZgZk3bA"
    var resOKM0      = new hdwallet.ExtendedKey() //
    resOKM0.initFromStringBase58(resOKAsStr)

    console.log(   hex( resOKM0.toRawBuffer()) ) 
  

    // dump
    var sDump  = ""
    sDump += "<hr>seed :     <p>" + hex( seed )
    sDump += "<hr>master key signature raw:   <p>" + hex( res.toRawBuffer() )
    sDump += "<hr>master key signature base58:<p>" + res.toStringBase58() + "<p>" + resOKAsStr
    sDump += "<p>" //+ hex(base58Decode(resOK))
    
    sDump += "<hr>m/0 raw:   <p>" + hex( extKeyM0.toRawBuffer() )
    sDump += "<p>m/0 base58: " + extKeyM0.toStringBase58() 
    sDump += "<hr> m/0 OK____: " + resOKAsStr
    sDump += "<p> m/0 OK raw: " + hex( resOKM0.toRawBuffer() )
    sDump += "<p> m/0 OK2____: " + resOKM0.toStringBase58() 

    document.getElementById("resultat").innerHTML = sDump;    
}

</script>

</body>
</html>