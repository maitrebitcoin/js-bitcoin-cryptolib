<!DOCTYPE html>
<html>
<body>

<h1> js-bitcoin-cryptolib debug page </h1>
<p><hr><p>

<button onclick="testBech32()">    <h2> Test bech32 </h2> </button>
<p>
<button onclick="testAll()">     <h2> Test ALL  </h2> </button>
<hr>
<button onclick="ecdsaSample()">   <h2> Ecdsa sample</h2> </button>
<button onclick="bip32Sample()">    <h2> bip32 sample</h2> </button>
<button onclick="bench()">    <h2> sha512 bench</h2> </button>
<p><p>

<p style="font-family:monospace;font-size:160%" id="resultat">
    <!--auto test result here-->
</p>

<!----------------------------- javscript code -------------------------------->


<script src='../src/js-bitcoin-lib.js'></script> 
<script src='../test/autotest.js'></script> 

<script>


function seedFromPhrase_x(  mnemonicPhrase,  password, x ) {
    var salt =  "mnemonic"
    if (password)
        salt += password
    return PBKDF2_512( hmac_sha512, mnemonicPhrase,  salt, x  )
}


function bench() {
    startTime = new Date();
   
    var phrase       =  "ozone drill grab fiber curtain grace pudding thank cruise elder eight picnic"

    // less iteration
    var seed = seedFromPhrase_x( phrase, "", 2048)
    //for (var i=0; i<1000; i++)   {  
        
        //var seed         = seedFromPhrase(phrase)

    //}
    endTime = new Date();
    var timeDiff = endTime - startTime; //in ms

    console.log(timeDiff)
    //if ( hex(seed) == "ba720e25b9c407f18d6dd87fb843fadd6b03395ca41225fcd997b190b27d0b93416724de52f90cd5c98300c52d2fbe74cf8ea3eb3025bf37857c21cee4098479" ) { //100 run
    if ( hex(seed) == "e2f88a043776c828063d4c3c97173944d32cf847a925b6e40b0b8bd0b4bead3ba734bdda5250d4698b310a71c9934e1a48e562315ce22bf85f89459df0e73a6c" ) { // 2048 run
        
        document.getElementById("resultat").innerHTML = "done - " + timeDiff +  "ms"
    }
    else {
            document.getElementById("resultat").innerHTML =" FAILDED <hr>" +  hex(seed)
            console.assert(false, hex(seed))
    }

}

// called if a test fails
function onTestFail( s, hashAsHexString, expected, message)
{
    var sErr = "test val = '" + s+ "') => <br>\n" +  hashAsHexString+' != <br>\n'+expected
    console.log(sErr)

    document.getElementById("resultat").innerHTML += "<p>"  +sErr + '<hr>' + message + "<p><font color='red'>FAILED</font>";
    console.assert(false)
    // stop the test
    throw -1;
}
// called if a test runs ok
function onTestOK( s )
{
    console.log(s + " OK")
    document.getElementById("resultat").innerHTML += "<p>"  + s + " <font color='green'>OK</font>";
}
// called when all tests runs ok (eend)
function onAllTestFinisedOK()
{
    console.log("ALL TEST PASSED OK")
    document.getElementById("resultat").innerHTML += "<p><font color='green'>ALL TEST PASSED OK</font>";
}

function testAll() {
    // Start...
    document.getElementById("resultat").innerHTML = "<font color='gray'>Running...</font>";
    // Run the test async :
    autotest_all( onTestFail, onTestOK, onAllTestFinisedOK  );
}

function testBech32() {
    // Start...
    document.getElementById("resultat").innerHTML += "<font color='gray'>Running...</font>";
    // Run tests...
    autotest_bip84(onTestFail)
    autotest_bech32( onTestFail  )
    // test PASSED OK
    document.getElementById("resultat").innerHTML += "<p><font color='green'>PASSED OK</font>";

}

function ecdsaSample() {

    var ecdsa = new ECDSA();
    // create key pair
    var privateKey = ecdsa.newPrivateKey();
    var pubKey     = ecdsa.publicKeyFromPrivateKey(privateKey);
    // show keys
    var sDump =     "private key :<p>" + privateKey.toString()
               + "<p>public  key :<p>" + pubKey.toString()

    var message = "my message to be signed"

    // generate signature
    var signature = ecdsa.signMessage( message, privateKey )
    // check signature
    var res = ecdsa.verifySignature(message, signature, pubKey )
    sDump += "<hr>test signature : " + res.message

    document.getElementById("resultat").innerHTML = sDump;
}

function bip32Sample() {

    //@test
    // https://stuff.birkenstab.de/pbkdf2/

    var test4 =      PBKDF2_512( hmac_sha512, "password","salt", 4 )
    //    "a3e4e33fc661f01e0a0824950576713fca8c6c27971aff4c3088b3d41442e723d4b603f204e07129f54e7f9a26456eab8ed8406b7a7a0c7917a7635abde2b1b7"
    console.log( hex(test4) )  


    var phrase ="pistol thunder want public animal educate laundry all churn federal slab behind media front glow"
    var seedOK = bufferFromHex("6e85439607050fad311b71238aacdd27d3095329201baa367c43e93869621de213f2c75dac958ecc1a87d55a94baf02e223de1d686c276882c112e841b01a8df");
    var seed = seedFromPhrase(phrase)
    console.log( hex(seed) )
    console.assert( seed == seedOK )
    
    var btcWallet = new hdwallet( seed, WalletType.SEGWIT_NATIVE );
    var extPub  = btcWallet.getExtendedPubliceKeyFromPath( DerivationPath.SW_NATIVE_BIP84 );
    console.log(  extPub.toStringBase58() ) 
  
    var adress = btcWallet.getSegwitNativePublicAdressFromPath(DerivationPath.SW_NATIVE_BIP84, 0)

    console.log(  adress ) 
  

    document.getElementById("resultat").innerHTML = adress;    
}

</script>

</body>
</html>